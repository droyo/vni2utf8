#include <u.h>
#include <libc.h>
#include <bio.h>

int placetone(Rune *b, Rune *e, int tone, Rune *end);
int isdelim(Rune r);
Rune vnichar(Rune r, int dia);
int istone(Rune r);
int isdia(Rune r);
int placetone(Rune *b, Rune *e, int tone, Rune *end);

enum mark {
	NEUTRAL,  SAC,      HUYEN,
	HOI,      NGA,      NANG,
	HAT,      HORN,     MOON,
	BAR
};

/*A      Ă      Â      E      Ê      I
  O      Ô      Ơ      U      Ư      Y
  a      ă      â      e      ê      i
  o      ô      ơ      u      ư      y 
  D      d*/
const Rune vni[][26] = {
 {0x0041,0x0102,0x00C2,0x0045,0x00CA,0x0049,
  0x004F,0x00D4,0x01A0,0x0055,0x01AF,0x0059,
  0x0061,0x0103,0x00E2,0x0065,0x00EA,0x0069,
  0x006F,0x00F4,0x01A1,0x0075,0x01B0,0x0079,
  0x0044,0x0064},

 {0x00C1,0x1EAE,0x1EA4,0x00C9,0x1EBE,0x00CD,
  0x00D3,0x1ED0,0x1EDA,0x00DA,0x1EE8,0x00DD,
  0x00E1,0x1EAF,0x1EA5,0x00E9,0x1EBF,0x00ED,
  0x00F3,0x1ED1,0x1EDB,0x00FA,0x1EE9,0x00FD,
  0x0000,0x0000},

 {0x00C0,0x1EB0,0x1EA6,0x00C8,0x1EC0,0x00CC,	
  0x00D2,0x1ED2,0x1EDC,0x00D9,0x1EEA,0x1EF2,
  0x00E0,0x1EB1,0x1EA7,0x00E8,0x1EC1,0x00EC,
  0x00F2,0x1ED3,0x1EDD,0x00F9,0x1EEB,0x1EF3,
  0x0000,0x0000},

 {0x1EA2,0x1EB2,0x1EA8,0x1EBA,0x1EC2,0x1EC8,
  0x1ECE,0x1ED4,0x1EDE,0x1EE6,0x1EEC,0x1EF6,
  0x1EA3,0x1EB3,0x1EA9,0x1EBB,0x1EC3,0x1EC9,
  0x1ECF,0x1ED5,0x1EDF,0x1EE7,0x1EED,0x1EF7,
  0x0000,0x0000},
 
 {0x00C3,0x1EB4,0x1EAA,0x1EBC,0x1EC4,0x0128,
  0x00D5,0x1ED6,0x1EE0,0x0168,0x1EEE,0x1EF8,
  0x00E3,0x1EB5,0x1EAB,0x1EBD,0x1EC5,0x0129,
  0x00F5,0x1ED7,0x1EE1,0x0169,0x1EEF,0x1EF9,
  0x0000,0x0000},

 {0x1EA0,0x1EB6,0x1EAC,0x1EB8,0x1EC6,0x1ECA,
  0x1ECC,0x1ED8,0x1EE2,0x1EE4,0x1EF0,0x1EF4,
  0x1EA1,0x1EB7,0x1EAD,0x1EB9,0x1EC7,0x1ECB,
  0x1ECD,0x1ED9,0x1EE3,0x1EE5,0x1EF1,0x1EF5,
  0x0000,0x0000},

 {0x00C2,0x0000,0x0000,0x00CA,0x0000,0x0000,
  0x00D4,0x0000,0x0000,0x0000,0x0000,0x0000,
  0x00E2,0x0000,0x0000,0x00EA,0x0000,0x0000,
  0x00F4,0x0000,0x0000,0x0000,0x0000,0x0000,
  0x0000,0x0000},

 {0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
  0x01A0,0x0000,0x0000,0x01AF,0x0000,0x0000,
  0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
  0x01A1,0x0000,0x0000,0x01B0,0x0000,0x0000,
  0x0000,0x0000},
 
 {0x0102,0x0000,0x0000,0x0000,0x0000,0x0000,
  0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
  0x0103,0x0000,0x0000,0x0000,0x0000,0x0000,
  0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
  0x0000,0x0000},
 
 {0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
  0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
  0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
  0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
  0x0110,0x0111}
};

Rune vnichar(Rune r, int dia) 
{
	int i;if(dia <= 0 || dia > 9) return r;
	for(i=0;i<26;i++) if (vni[0][i] == r) return vni[dia][i];
	return r;
}

int isdelim(Rune r)
{
	char del[] =" \t\r\n'\"!@#$%^&*()[]{}-+=_<>,.;:";
	int i; for(i=0;i<nelem(del);i++)
		if(r == del[i]) return 1;
	return r == Beof;
}

int istone(Rune r)
{
	return r > '0' && r < '6';
}
int isdia(Rune r)
{
	return r > '5' && r <= '9';
}

/* The tones always go on the vowels. If there are many
 * vowels in a word, the sign will go on the last vowel,
 * unless that vowel ends the word. */

int placetone(Rune *b, Rune *e, int tone, Rune *end)
{
	Rune *v;
	Rune t;
	for(v=e-1;v>b;v--) {
		t = vnichar(*v,tone);
		if(t != *v && v+1 == end) {
			if (!placetone(b,v,tone,end))
				*v = t;
			return 1;
		} else if (t != *v) {
			*v = t;
			return 1;
		}
	}
	return 0;
}

int main(int argc, char **argv)
{
	int isviet;
	enum mark tone;
	Rune r, t;
	Rune word[16], *e, *s;
	Biobuf *rd = Bfdopen(0,O_RDONLY);
	Biobuf *wr = Bfdopen(1,O_WRONLY);
	
	e = word; isviet = 1; 
	tone = 0;
	while((r = Bgetrune(rd))) {
		if (isdelim(r)) {
			if(!isviet) {
				isviet = 1;
				Bputrune(wr,r);
				continue;
			}
			*e = 0;
			placetone(word,e,tone,e);
			Bprint(wr,"%S",word);
			e = word;
			tone = NEUTRAL;
			if(r != Beof) Bputrune(wr,r);
			if(r == '\n') Bflush(wr);
		} else if (!isviet) {
			Bputrune(wr,r);
			continue;
		} else if (e>word && istone(r) && tone == NEUTRAL) {
			tone = r - '0';
			continue;
		} else if (isdia(r) && e>word) {
			s = e-1;
			t = vnichar(*s,r-'0');
			if(t && t != *s) *s = t;
			else *e++ = r;
		} else if (e-word > nelem(word)-1) {
			*e=0; Bprint(wr,"%S",word);
			e=word;
			isviet=0;
		} else *e++ = r;
		if (r == Beof) break;
	}
	return 0;
}
